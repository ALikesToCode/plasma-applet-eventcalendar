#!/usr/bin/env bash
if [ -z "${BASH_VERSION:-}" ]; then
    exec /usr/bin/env bash "$0" "$@"
fi

set -euo pipefail

# Set up logging
LOG_FILE="/tmp/plasma-widget-uninstall.log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

cleanup() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        log "ERROR: Script failed with exit code $exit_code"
    fi
    exit $exit_code
}

trap cleanup EXIT

# Configuration
METADATA_FILE="$PWD/package/metadata.json"
BACKUP_DIR="$HOME/.local/share/plasma-widget-backups/$(date +%Y%m%d_%H%M%S)"

# Verify metadata file exists
if [ ! -f "$METADATA_FILE" ]; then
    log "ERROR: metadata.json file not found in the package directory."
    exit 1
fi

# Create backup directory
mkdir -p "$BACKUP_DIR"
cp -r "./package" "$BACKUP_DIR/"
log "Backup created at: $BACKUP_DIR"

# Install jq if needed
if ! command -v jq &> /dev/null; then
    log "Installing jq..."
    if [ -f /etc/debian_version ]; then
        sudo apt-get install -y jq
    elif [ -f /etc/arch-release ]; then
        sudo pacman -S jq
    elif [ -f /etc/fedora-release ]; then
        sudo dnf install -y jq
    fi
fi

# Read package information
packageName=$(jq -r '.KPlugin.Id' "$METADATA_FILE")

if [ -z "$packageName" ]; then
    log "ERROR: Unable to read the package name from metadata.json."
    exit 1
fi

QDBUS_BIN=$(command -v qdbus || command -v qdbus6) || {
    echo "qdbus not found" >&2
    exit 1
}

# Remove package
INSTALL_DIR="$HOME/.local/share/plasma/plasmoids/$packageName"
if [ -d "$INSTALL_DIR" ]; then
    log "Removing package: $packageName"
    rm -rf "$INSTALL_DIR"
    
    # Remove plasmoid instances
    log "Removing plasmoid instances..."
    "$QDBUS_BIN" org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript "
        var allDesktops = desktops();
        for (var i = 0; i < allDesktops.length; i++) {
            var d = allDesktops[i];
            var widgets = d.widgets();
            for (var j = 0; j < widgets.length; j++) {
                var w = widgets[j];
                if (w.type == 'org.kde.plasma.eventcalendar') {
                    w.remove();
                }
            }
        }
    "
    
    log "Package removal successful."
else
    log "Package not found: $packageName"
    exit 1
fi
