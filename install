#!/usr/bin/env bash
if [ -z "${BASH_VERSION:-}" ]; then
    exec /usr/bin/env bash "$0" "$@"
fi

set -euo pipefail

# Set up logging
LOG_FILE="/tmp/plasma-widget-install.log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

cleanup() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        log "ERROR: Script failed with exit code $exit_code"
    fi
    exit $exit_code
}

trap cleanup EXIT

# Function to check if a command was successful
check_command_success() {
    if [ "$1" != "0" ]; then
        echo "Error executing command: $2"
        exit 1
    fi
}

DISTRO=""
DISTRO_LIKE=""
DISTRO_FAMILY=""

detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO="${ID:-}"
        DISTRO_LIKE="${ID_LIKE:-}"
    elif type lsb_release >/dev/null 2>&1; then
        DISTRO=$(lsb_release -i | cut -d: -f2 | sed s/'^\t'//)
        DISTRO_LIKE=""
    else
        DISTRO=$(uname -s)
        DISTRO_LIKE=""
    fi

    DISTRO=$(echo "$DISTRO" | tr '[:upper:]' '[:lower:]')
    DISTRO_LIKE=$(echo "$DISTRO_LIKE" | tr '[:upper:]' '[:lower:]')

    DISTRO_FAMILY="$DISTRO"
    case " $DISTRO $DISTRO_LIKE " in
        *"arch"*|*"endeavouros"*|*"manjaro"*|*"garuda"*)
            DISTRO_FAMILY="arch"
            ;;
        *"debian"*|*"ubuntu"*|*"neon"*|*"kali"*|*"raspbian"*)
            DISTRO_FAMILY="debian"
            ;;
        *"fedora"*|*"rhel"*|*"centos"*)
            DISTRO_FAMILY="fedora"
            ;;
    esac
}

install_packages() {
    case "$DISTRO_FAMILY" in
        "debian")
            sudo apt-get update
            sudo apt-get install -y "$@"
            ;;
        "arch")
            sudo pacman -S --needed "$@"
            ;;
        "fedora")
            sudo dnf install -y "$@"
            ;;
        *)
            echo "Unsupported distribution: ${DISTRO:-unknown}"
            return 1
            ;;
    esac
}

# Function to install required packages
install_requirements() {
    detect_distro

    case "$DISTRO_FAMILY" in
        "debian")
            required_commands=("kpackagetool6")
            packages_to_install=("kpackagetool6")
            ;;
        "arch")
            required_commands=("kpackagetool6")
            packages_to_install=("kpackage")
            ;;
        "fedora")
            required_commands=("kpackagetool6")
            packages_to_install=("kf6-kpackage")
            ;;
        *)
            echo "Unsupported distribution: ${DISTRO:-unknown}"
            return 1
            ;;
    esac

    for i in "${!required_commands[@]}"; do
        if ! command -v "${required_commands[$i]}" &> /dev/null; then
            echo "${required_commands[$i]} is not installed. Attempting to install..."
            install_packages "${packages_to_install[$i]}"
            check_command_success "$?" "Failed to install ${packages_to_install[$i]}"
        fi
    done
}

# Install script requirements
install_requirements

# Parse arguments
restartPlasmashell=false
METADATA_FILE="$PWD/package/metadata.json"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -r|--restart) restartPlasmashell=true; shift ;;
        *) log "WARNING: Unknown parameter: $1"; shift ;;
    esac
done

# Verify metadata file exists
if [ ! -f "$METADATA_FILE" ]; then
    log "ERROR: metadata.json file not found"
    exit 1
fi

# Install jq if needed
if ! command -v jq &> /dev/null; then
    log "Installing jq..."
    install_packages "jq"
    check_command_success "$?" "Failed to install jq"
fi

# Read package information
packageNamespace=$(jq -r '.KPlugin.Id' "$METADATA_FILE")

if [ -z "$packageNamespace" ]; then
    log "ERROR: Failed to read package information from metadata.json"
    exit 1
fi

# Check if package is already installed
if ! kpackagetool6 --list-types | grep -q "Plasma/Applet"; then
    log "ERROR: Plasma/Applet package type not available"
    exit 1
fi

# Install or update the package
INSTALL_DIR="$HOME/.local/share/plasma/plasmoids"
mkdir -p "$INSTALL_DIR"

if [ -d "$INSTALL_DIR/$packageNamespace" ]; then
    log "Updating existing package..."
    rm -rf "$INSTALL_DIR/$packageNamespace"
fi

log "Installing package..."
cp -r package "$INSTALL_DIR/$packageNamespace"

QDBUS_BIN=$(command -v qdbus || command -v qdbus6) || {
    echo "qdbus not found" >&2
    exit 1
}

# Reload plasmoid configuration
if $restartPlasmashell; then
    log "Reloading plasmoid..."
    "$QDBUS_BIN" org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript "
        var allDesktops = desktops();
        for (var i = 0; i < allDesktops.length; i++) {
            var d = allDesktops[i];
            var widgets = d.widgets();
            for (var j = 0; j < widgets.length; j++) {
                var w = widgets[j];
                if (w.type == 'org.kde.plasma.eventcalendar') {
                    w.reloadConfig();
                }
            }
        }
    "
fi

log "Installation completed successfully."
